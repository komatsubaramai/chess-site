<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chessboard with FEN</title>
  <script src="js/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
  <script src="js/chessboard-1.0.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    button { width: 200px; height: 100px; }
    textarea { width: 200px; height: 200px; }
  </style>
</head>
<body>
  <div style="display: flex; flex-direction: column; gap: 20px;">
    <div style="display: flex; flex-wrap: wrap; gap: 30px;">
      <div>
        <div id="myBoard" style="width: 300px;"></div>
        <p id="output"></p>
      </div>
      <div>
        <canvas id="evalChart" width="800" height="400"></canvas>
      </div>
    </div>
    <div style="display: flex; gap: 20px; align-items: flex-start;">
        <textarea id="settext"></textarea>
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            <button id="setStartBtn">初期盤面に戻す</button>
            <button id="showtextBtn">fen読み込み</button>
            <button id="prevBtn">戻る</button>
            <button id="nextBtn">次へ</button>
        </div>
    </div>
  </div>

<script>
  var fenList = [];
  var cpValues = [];
  var legalList = [[]];
  var legalMove = [[]];
  var legalcpValues = [[]];
  var currentIndex = 0;
  var linenum = 0;
  var board = Chessboard('myBoard', {position: 'start'});
  var evalChart;

  function legalmoveposition(num) {
    const files = ['a','b','c','d','e','f','g','h'];
    const file = files[num % 8];
    const rank = Math.floor(num / 8) + 1;
    return file + rank;
  }

  $('#setStartBtn').on('click', function () {
    board.start();
  });

  $('#showtextBtn').on('click', function () {
    const inputVal = $('#settext').val().trim();
    const lines = inputVal.split('\n').filter(line => line.trim() !== '');
    fenList = [];
    cpValues = [];
    legalList = [[]];
    legalMove = [[]];
    legalcpValues = [[]];
    linenum = 0;

    lines.forEach(line => {
      const iv = line.split(' ');
      const parts = line.split(' cp ');

      if (iv.length == 11) {
        fenList.push(parts[0].trim());
        let cp = parseInt(iv[5].trim());
        if (linenum % 2 === 0) cp *= -1;
        cpValues.push(cp);
        legalList[linenum] = [];
        legalMove[linenum] = [];
        legalcpValues[linenum] = [];
        linenum++;
      } else if (iv.length == 12) {
        legalList[linenum].push(parts[0].trim());
        let legalcp = parseInt(iv[7].trim());
        if (linenum % 2 === 1) legalcp *= -1;
        legalcpValues[linenum].push(legalcp);
      } else if (line.startsWith('move>')) {
        const match = line.match(/move> (\d+)->(\d+)/);
        if (match && linenum >= 0) {
          const from = parseInt(match[1]);
          const to = parseInt(match[2]);
          const moveStr = `${legalmoveposition(from)} → ${legalmoveposition(to)}`;
          legalMove[linenum].push(moveStr);
        }
      }
    });

    currentIndex = 0;
    if (fenList.length > 0) {
      board.position(fenList[currentIndex]);
      $('#output').text(`手数: ${currentIndex + 1} / ${fenList.length}`);
      updateChart(cpValues);
    }
  });

  $('#nextBtn').on('click', function () {
    if (currentIndex < fenList.length - 1) {
      currentIndex++;
      board.position(fenList[currentIndex]);
      $('#output').text(`手数: ${currentIndex + 1} / ${fenList.length}`);
      updateCurrentPoint();
    }
  });

  $('#prevBtn').on('click', function () {
    if (currentIndex > 0) {
      currentIndex--;
      board.position(fenList[currentIndex]);
      $('#output').text(`手数: ${currentIndex + 1} / ${fenList.length}`);
      updateCurrentPoint();
    }
  });

  function updateCurrentPoint() {
    if (!evalChart) return;
    const dataset = evalChart.data.datasets.find(ds => ds.label === '現在の指し手');
    if (dataset) {
      dataset.data = [{ x: currentIndex + 1, y: cpValues[currentIndex] }];
      evalChart.update('none');
    }
  }

  function updateChart(values) {
    if (evalChart) evalChart.destroy();
    const ctx = document.getElementById('evalChart').getContext('2d');

    const allPoints = values.map((cp, i) => ({ x: i + 1, y: cp }));
    const whitePoints = [], blackPoints = [], whiteLegalPoints = [], blackLegalPoints = [];

    values.forEach((cp, i) => {
      const point = { x: i + 1, y: cp };
      (i % 2 === 0 ? whitePoints : blackPoints).push(point);
    });

    legalcpValues.forEach((cpList, i) => {
      cpList.forEach((cp, j) => {
        const move = legalMove[i]?.[j] || '不明な手';
        const point = { x: i + 1, y: cp, move: move };
        (i % 2 === 0 ? whiteLegalPoints : blackLegalPoints).push(point);
      });
    });

    const currentPoint = [{
      x: currentIndex + 1,
      y: values[currentIndex]
    }];

    evalChart = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [
          { label: '評価値（全体）', type: 'line', data: allPoints, borderColor: 'blue', backgroundColor: 'blue', tension: 0.1 },
          { label: '評価値（白手番）', type: 'line', data: whitePoints, borderColor: 'skyblue', backgroundColor: 'skyblue', tension: 0.1, hidden: true },
          { label: '評価値（黒手番）', type: 'line', data: blackPoints, borderColor: 'orange', backgroundColor: 'orange', tension: 0.1, hidden: true },
          { label: '合法手（白）', type: 'scatter', data: whiteLegalPoints, backgroundColor: 'tomato', borderColor: 'darkred', borderWidth: 0.5, pointRadius: 4 },
          { label: '合法手（黒）', type: 'scatter', data: blackLegalPoints, backgroundColor: 'skyblue', borderColor: 'navy', borderWidth: 0.5, pointRadius: 4 },
          { label: '現在の指し手', type: 'scatter', data: currentPoint, backgroundColor: 'red', borderColor: 'darkred', borderWidth: 2, pointRadius: 6 }
        ]
      },
      options: {
        scales: {
          x: { title: { display: true, text: '手数' }, ticks: { stepSize: 1 } },
          y: { title: { display: true, text: 'cp評価値' } }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function (context) {
                const move = context.raw?.move || '';
                const cp = context.parsed.y;
                return context.dataset.label.includes('合法手') ?
                  `${context.dataset.label}: ${move} (cp: ${cp})` :
                  `${context.dataset.label}: cp ${cp}`;
              }
            }
          },
          legend: { display: true, labels: { usePointStyle: true } }
        },
        onClick: (e, elements) => {
          const index = elements[0]?.element?.$context?.parsed?.x;
          if (index && fenList[index - 1]) {
            currentIndex = index - 1;
            board.position(fenList[currentIndex]);
            $('#output').text(`手数: ${currentIndex + 1} / ${fenList.length}`);
            updateCurrentPoint();
          }
        }
      }
    });
  }
</script>
</body>
</html>
